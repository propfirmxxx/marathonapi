services:
  marathon-api:
    image: devenio/marathonapi:dev
    restart: unless-stopped
    ports:
      - "3000:3000"
    # All environment variables from .env.compose.prod
    env_file:
      - .env.compose.prod
    depends_on:
      db:
        condition: service_healthy
      minio:
        condition: service_healthy
    volumes:
      - uploads-data:/usr/src/app/uploads:rw
    environment:
      # Docker API access via docker-socket-proxy (secure)
      - DOCKER_HOST=tcp://docker-socket-proxy:2375
      # MinIO/S3 configuration for object storage
      - MINIO_ENDPOINT=${MINIO_ENDPOINT:-minio}
      - MINIO_PORT=${MINIO_PORT:-9000}
      - MINIO_USE_SSL=${MINIO_USE_SSL:-false}
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY:-minioadmin}
      - MINIO_SECRET_KEY=${MINIO_SECRET_KEY:-minioadmin}
      - MINIO_BUCKET=${MINIO_BUCKET:-marathon-uploads}
    networks:
      - marathon-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    mem_limit: 2g
    mem_reservation: 512m
    cpus: '2.0'
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    security_opt:
      - no-new-privileges:true

  marathon-front:
    image: devenio/marathon-front:latest
    restart: unless-stopped
    ports:
      - "4010:4010"
    networks:
      - marathon-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4010/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    mem_limit: 1g
    mem_reservation: 256m
    cpus: '1.0'
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    security_opt:
      - no-new-privileges:true
  
  marathon-mt5-python:
    image: devenio/marathon-metapython:latest
    restart: unless-stopped
    ports:
      - "8888:8888"
      - "8000:8000"
    volumes:
      - ./meta-configs:/app/meta-configs:rw
    networks:
      - marathon-network
    environment:
      # Docker API access via docker-socket-proxy (secure)
      - DOCKER_HOST=tcp://docker-socket-proxy:2375
      - RABBITMQ_URL=amqp://guest:guest@rabbitmq:5672/
      - RABBITMQ_QUEUE=socket_data
      - CONFIG_DIRECTORY_HOST=${PWD:-C:/Users/10/Desktop/marathonapi}/meta-configs
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    mem_limit: 2g
    mem_reservation: 512m
    cpus: '2.0'
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    security_opt:
      - no-new-privileges:true
    
  db:
    image: postgres:15-alpine
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${DB_USERNAME:-postgres}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-postgres}
      POSTGRES_DB: ${DB_NAME:-marathon}
      POSTGRES_INITDB_ARGS: "--auth-host=scram-sha-256 --auth-local=scram-sha-256"
    volumes:
      - pgdata:/var/lib/postgresql/data
    # Remove port exposure for production security
    # ports:
    #   - "54321:5432"
    networks:
      - marathon-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USERNAME:-postgres} -d ${DB_NAME:-marathon}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    mem_limit: 2g
    mem_reservation: 512m
    cpus: '2.0'
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    security_opt:
      - no-new-privileges:true

  directus:
    image: directus/directus:11.13.4
    restart: unless-stopped
    ports:
      - "8055:8055"
    volumes:
      - directus-database-data:/directus/database
      - directus-uploads-data:/directus/uploads
      - directus-extensions-data:/directus/extensions
    networks:
      - marathon-network
    depends_on:
      db:
        condition: service_healthy
      docker-socket-proxy:
        condition: service_healthy
    environment:
      # Use environment variables from compose.env
      SECRET: thisisasupersecretsecret
      ADMIN_EMAIL: ${DIRECTUS_ADMIN_EMAIL:-admin@example.com}
      ADMIN_PASSWORD: ${DIRECTUS_ADMIN_PASSWORD:-admin}

      WEBSOCKETS_ENABLED: "true"

      DB_CLIENT: "pg"
      DB_HOST: "db"
      DB_PORT: "5432"
      DB_DATABASE: ${DB_NAME:-marathon}
      DB_USER: ${DB_USERNAME:-postgres}
      DB_PASSWORD: ${DB_PASSWORD:-postgres}

      # CACHE_ENABLED: "true"
      # CACHE_AUTO_PURGE: "true"
      # CACHE_STORE: "redis"
      # REDIS: "redis://cache:6379"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8055/server/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    mem_limit: 1g
    mem_reservation: 256m
    cpus: '1.0'
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    security_opt:
      - no-new-privileges:true

  rabbitmq:
    image: rabbitmq:4-management
    restart: unless-stopped
    ports:
      - "15672:15672"  # Management UI
      - "5672:5672"    # AMQP port
    networks:
      - marathon-network
    environment:
      # Authentication (change in production!)
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:-guest}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASS:-guest}
      
      # Performance tuning (Erlang VM args)
      RABBITMQ_SERVER_ADDITIONAL_ERL_ARGS: >-
        +P 1048576
        +Q 65536
        +K true
        +A 128
      
      # Note: Memory, disk, and connection settings are configured in
      # rabbitmq-configs/rabbitmq.conf to avoid deprecated environment variables
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    mem_limit: 2g
    mem_reservation: 512m
    cpus: '2.0'
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
      - rabbitmq-configs-data:/etc/rabbitmq/conf.d:ro
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    security_opt:
      - no-new-privileges:true

  nginx:
    image: nginx:alpine
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    networks:
      - marathon-network
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - nginx-logs-data:/var/log/nginx
      # Let's Encrypt certificates (created by setup-ssl.sh)
      - ./letsencrypt/conf:/etc/letsencrypt:ro
      - ./letsencrypt/www:/var/www/certbot:ro
    depends_on:
      - marathon-front
      - docker-socket-proxy
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/nginx-health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    mem_limit: 512m
    mem_reservation: 128m
    cpus: '1.0'
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    security_opt:
      - no-new-privileges:true

  # Docker Socket Proxy - Secure Docker API access
  docker-socket-proxy:
    image: tecnativa/docker-socket-proxy:latest
    restart: unless-stopped
    networks:
      - marathon-network
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      # Allow only safe Docker API operations
      # Containers: list, inspect, start, stop, restart, logs
      # Images: list, inspect, pull
      # Networks: list, inspect
      # Volumes: list, inspect
      # NO: delete, prune, exec, create, remove operations
      CONTAINERS: 1
      IMAGES: 1
      NETWORKS: 1
      VOLUMES: 1
      INFO: 1
      VERSION: 1
      POST: 1
      # Disable dangerous operations
      DELETE: 0
      BUILD: 0
      COMMIT: 0
      EVENTS: 0
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:2375/_ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    mem_limit: 256m
    mem_reservation: 64m
    cpus: '0.5'
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    security_opt:
      - no-new-privileges:true

  # MinIO - S3-compatible object storage (optional, recommended for production)
  # Using RELEASE.2022-11-11T03-44-20Z which supports base x86-64 (not requiring x86-64-v2)
  minio:
    image: minio/minio:RELEASE.2022-11-11T03-44-20Z
    restart: unless-stopped
    ports:
      - "9000:9000"  # API
      - "9001:9001"  # Console
    networks:
      - marathon-network
    volumes:
      - minio-data:/data
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    mem_limit: 1g
    mem_reservation: 256m
    cpus: '1.0'
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    security_opt:
      - no-new-privileges:true

  # PostgreSQL Backup Service
  postgres-backup:
    image: postgres:15-alpine
    restart: "no"  # Manual backup, not auto-restart
    depends_on:
      db:
        condition: service_healthy
    volumes:
      - pgdata:/var/lib/postgresql/data:ro
      - ./backups/postgres:/backup
    env_file:
      - .env.compose.prod
    environment:
      PGHOST: db
      PGPORT: 5432
      PGDATABASE: ${DB_NAME:-marathon}
      PGUSER: ${DB_USERNAME:-postgres}
      PGPASSWORD: ${DB_PASSWORD:-postgres}
    command: >
      sh -c "
        mkdir -p /backup &&
        pg_dump -h $$PGHOST -p $$PGPORT -U $$PGUSER -d $$PGDATABASE -F c -f /backup/marathon_$$(date +%Y%m%d_%H%M%S).dump &&
        echo 'Backup completed: marathon_$$(date +%Y%m%d_%H%M%S).dump'
      "
    profiles:
      - backup  # Only run when explicitly requested

volumes:
  pgdata:
    driver: local
  rabbitmq-data:
    driver: local
  rabbitmq-configs-data:
    driver: local
    # RabbitMQ configuration files
  uploads-data:
    driver: local
    # Isolated volume - not accessible from host filesystem
  directus-database-data:
    driver: local
    # Directus database files
  directus-uploads-data:
    driver: local
    # Isolated volume - not accessible from host filesystem
  directus-extensions-data:
    driver: local
    # Directus extensions
  minio-data:
    driver: local
    # MinIO object storage data
  nginx-logs-data:
    driver: local
    # Nginx logs

networks:
  marathon-network:
    driver: bridge
