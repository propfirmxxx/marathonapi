services:
  marathon-api:
    # build:
    #   context: .
    #   dockerfile: Dockerfile
    image: devenio/marathonapi:dev
    restart: unless-stopped
    develop:
      watch:
        - action: sync
          path: ./
          target: /usr/src/app
          ignore:
            - node_modules/
            - uploads/
            - directus-database/
            - directus-uploads/
            - directus-extensions/
            - meta-configs/
            - pgdata/
            - rabbitmq-data/
            - .git/
            - .env
            - .env.compose
    ports:
      - "3000:3000"
    env_file:
      - .env.compose
    # environment:
      # Override with environment variables from compose.env
      # - NODE_ENV=production
    depends_on:
      db:
        condition: service_healthy
    volumes:
      - ./uploads:/usr/src/app/uploads:rw
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - marathon-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    security_opt:
      - no-new-privileges:true

  marathon-front:
    image: devenio/marathon-front:latest
    restart: unless-stopped
    ports:
      - "4010:4010"
    networks:
      - marathon-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4010/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    security_opt:
      - no-new-privileges:true
  
  marathon-mt5-python:
    image: devenio/marathon-metapython:latest
    restart: unless-stopped
    ports:
      - "8888:8888"
      - "8000:8000"
    volumes:
      - ./meta-configs:/app/meta-configs
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - marathon-network
    environment:
      - RABBITMQ_URL=amqp://guest:guest@rabbitmq:5672/
      - RABBITMQ_QUEUE=socket_data
      - CONFIG_DIRECTORY_HOST=${PWD:-C:/Users/10/Desktop/marathonapi}/meta-configs
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    security_opt:
      - no-new-privileges:true
    
  db:
    image: postgres:15-alpine
    restart: unless-stopped
    environment:
      # These should be set in environment or secrets
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: marathon
      POSTGRES_INITDB_ARGS: "--auth-host=scram-sha-256 --auth-local=scram-sha-256"
    volumes:
      - pgdata:/var/lib/postgresql/data
    # Remove port exposure for production security
    # ports:
    #   - "54321:5432"
    networks:
      - marathon-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-marathon}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    security_opt:
      - no-new-privileges:true

  directus:
    image: directus/directus:latest
    restart: unless-stopped
    ports:
      - 8055:8055
    volumes:
      - ./directus-database:/directus/database
      - ./directus-uploads:/directus/uploads
      - ./directus-extensions:/directus/extensions
    networks:
      - marathon-network
    depends_on:
      db:
        condition: service_healthy
    environment:
      # Use environment variables from compose.env
      SECRET: thisisasupersecretsecret
      ADMIN_EMAIL: ${DIRECTUS_ADMIN_EMAIL:-admin@example.com}
      ADMIN_PASSWORD: ${DIRECTUS_ADMIN_PASSWORD:-admin}

      WEBSOCKETS_ENABLED: "true"

      DB_CLIENT: "pg"
      DB_HOST: "db"
      DB_PORT: "5432"
      DB_DATABASE: ${POSTGRES_DB:-marathon}
      DB_USER: ${POSTGRES_USER:-postgres}
      DB_PASSWORD: ${POSTGRES_PASSWORD:-postgres}

      # CACHE_ENABLED: "true"
      # CACHE_AUTO_PURGE: "true"
      # CACHE_STORE: "redis"
      # REDIS: "redis://cache:6379"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8055/server/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    security_opt:
      - no-new-privileges:true

  rabbitmq:
    image: rabbitmq:4-management
    restart: unless-stopped
    ports:
      - "15672:15672"  # Management UI
      - "5672:5672"    # AMQP port
    networks:
      - marathon-network
    environment:
      # Authentication (change in production!)
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:-guest}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASS:-guest}
      
      # Performance tuning (Erlang VM args)
      RABBITMQ_SERVER_ADDITIONAL_ERL_ARGS: >-
        +P 1048576
        +Q 65536
        +K true
        +A 128
      
      # Note: Memory, disk, and connection settings are configured in
      # rabbitmq-configs/rabbitmq.conf to avoid deprecated environment variables
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
      - ./rabbitmq-configs:/etc/rabbitmq/conf.d:ro
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    security_opt:
      - no-new-privileges:true

volumes:
  pgdata:
    driver: local
  rabbitmq-data:
    driver: local

networks:
  marathon-network:
    driver: bridge
